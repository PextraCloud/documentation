name: Deploy documentation site
on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install mdBook and plugins
        run: |
          echo "${HOME}/.cargo/bin" >> $GITHUB_PATH
          command -v mdbook >/dev/null 2>&1 || cargo install mdbook --no-default-features --features search --locked --force
          command -v mdbook-llms-txt-tools >/dev/null 2>&1 || cargo install --git https://github.com/PextraCloud/mdbook-llms-txt-tools --force
          command -v mdbook-utils >/dev/null 2>&1 || cargo install mdbook-utils --force

      - name: Configure Pages
        uses: actions/configure-pages@v4

      - name: Build documentation
        run: |
          mdbook build cloudenvironment

      - name: Generate sitemap
        run: |
          mdbook-utils sitemap -b https://docs.pextra.cloud -o cloudenvironment/book/html/sitemap.xml

      - name: Install Perl dependencies
        run: sudo apt install libfile-copy-recursive-perl

      - name: Run post-build script(s)
        run: |
          perl ./merge-dirs.pl cloudenvironment/book/html cloudenvironment/book/markdown cloudenvironment/book/llms-txt cloudenvironment/book/llms-txt-full cloudenvironment/static cloudenvironment/book/merged

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'cloudenvironment/book/merged'

      - name: Deploy to Pages
        id: documentation
        uses: actions/deploy-pages@v4
        
      - name: Create documentation package
        run: tar -czf pce-docs.tar.gz -C cloudenvironment/book/merged .

      - run: echo "COMMIT_SHA_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: pce-docs.tar.gz
          tag_name: docs-${{ env.COMMIT_SHA_SHORT }}
          name: docs-${{ env.COMMIT_SHA_SHORT }}
          body: |
            This release contains the latest documentation package. The documentation package is used by Pextra CloudEnvironmentÂ® to provide an offline version of the documentation.
          draft: false
          prerelease: false
